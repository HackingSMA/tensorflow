#From the root of the repo execute the following:

# start clean
git reset --hard HEAD
git clean -fxd

# get rid of /opt/local/lib library paths (prevents linking with wrong zlib)
unset DYLD_FALLBACK_LIBRARY_PATH
unset LIBRARY_PATH

# adjust to taste:
BUILD_TARGET="x86_64 armv7 arm64"

./tensorflow/contrib/makefile/download_dependencies.sh
./tensorflow/contrib/makefile/rename_protobuf.sh
./tensorflow/contrib/makefile/compile_ios_protobuf.sh -a "$BUILD_TARGET"
export HOST_NSYNC_LIB=`tensorflow/contrib/makefile/compile_nsync.sh`
export TARGET_NSYNC_LIB=`tensorflow/contrib/makefile/compile_nsync.sh -t ios  -a "$BUILD_TARGET"`


### NOTE: THIS WILL FAIL (that's expected)
tensorflow/contrib/makefile/compile_ios_tensorflow.sh -f "-Os" -h $HOST_NSYNC_LIB -n $TARGET_NSYNC_LIB -a "$BUILD_TARGET"


# fix it
find tensorflow/contrib/makefile/gen/ -type f \( -name "*.cc" -or -name "*.h" \) -exec sed -i '' 's%\([ :&(<]\)protobuf_%\1protobuf3_%g' {} \;

# try again
tensorflow/contrib/makefile/compile_ios_tensorflow.sh -f "-Os" -h $HOST_NSYNC_LIB -n $TARGET_NSYNC_LIB -a "$BUILD_TARGET"

# package desired architectures, rename and copy into a single directory
mkdir ios
cp ./tensorflow/contrib/makefile/gen/lib/libtensorflow-core.a ios
cp .tensorflow/contrib/makefile/gen/protobuf_ios/lib/libprotobuf.a ios/libprotobuf3.a
cp .tensorflow/contrib/makefile/gen/protobuf_ios/lib/libprotobuf-lite.a libprotobuf3-lite.a
lipo -create -output ./ios/libnsync.a ./tensorflow/contrib/makefile/downloads/nsync/builds/x86_64.ios.c++11/libnsync.a ./tensorflow/contrib/makefile/downloads/nsync/builds/armv7.ios.c++11/libnsync.a ./tensorflow/contrib/makefile/downloads/nsync/builds/arm64.ios.c++11/libnsync.a 
